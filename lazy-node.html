<link rel="import"
href="http://www.polymer-project.org/1.0/samples/components/polymer/polymer.html">

<dom-module id="lazy-node">

    <template>
        <li>
            <p>{{nodeLabel}}</p>
            <ul id='foo'></ul>
        </li>
    </template>

</dom-module>

<script>

    var LazyNode = Polymer({

        is: 'lazy-node',

        properties: {
            nodeLabel: {
                type: String,
                value: "DEFAULT"
            },
            level: {
                type: Number,
                value: 0
            },
            treePath: {
                type: Object,
                value: ['root']
            },
            childLazyNodes: {
                type: Object,
                value: []
            }
        },

        factoryImpl: function(level, treePath) {
            this.level = level;
            this.treePath = treePath;
            this.nodeLabel = this.getNodeLabel(this.treePath);
        },

        listeners: {
            'click': 'handleClick'
        },

        handleClick: function (e) {
            console.log('LazyNode ' + this.nodeLabel + ' clicked!');
            console.log('this.$.foo =');
            console.log(this.$.foo);
            var childLevel = this.level + 1;
            var childPaths = this.loadChildren(this.treePath);
            childPaths.forEach(function(childPath) {
                this.childLazyNodes.push(new LazyNode(childLevel, childPath));
            }.bind(this));
            this.childLazyNodes.forEach(function(child) {
                this.$$('#foo').appendChild(child);
            }.bind(this));
        },

        arrayToLabelString: function(a) {
            var labelStr = '';
            a.forEach(function(e, i) {
                labelStr += e;
                if (i < a.length - 1) labelStr += ', ';
            });
            return labelStr;
        },

        /*
         * Returns the label for the node at treePath.
         */
        getNodeLabel: function(treePath) {
            var term = this.arrayToLabelString(treePath);
            term += " (" + this.level + ")";
            return term;
        },

        MAX_CHILD_NODES: 10,
        MAX_NODES_L1: 100,
        /*
         * Returns an array of labels for all children under the node at treePath.
         * treePath starts with ['root'] for the root node. Then ['root', 0] is the first child of the root.
         * ['root', 1] is the second child of the root. etc.
         * Placeholder for an API endpoint call.
         */
        loadChildren: function(treePath) {
            var numNodes;
            var maxNodes;
            if (!treePath) return [];
            if (treePath.length === 1) {
                maxNodes = this.MAX_NODES_L1;
            } else {
                maxNodes = this.MAX_CHILD_NODES;
            }
            numNodes = Math.max(Math.floor(Math.random() * maxNodes), 1);
            var nodes = [];
            for (var i = 0; i < numNodes; i ++) {
                nodes.push(treePath.concat(i));
            }
            return nodes;
        },


        created: function() {
            //console.log(this.localName + '#' + this.id + ' was created');
        }

    });

</script>
