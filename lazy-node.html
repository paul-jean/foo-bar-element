<link rel="import"
href="http://www.polymer-project.org/1.0/samples/components/polymer/polymer.html">

<dom-module id="lazy-node">

    <template>
        <li>
            <p>{{nodeLabel}}</p>
            <ul id='{{lazyNodeID}}'></ul>
        </li>
    </template>

</dom-module>

<script>

    var LazyNode = Polymer({

        is: 'lazy-node',

        properties: {
            nodeLabel: {
                type: String,
                value: "DEFAULT"
            },
            level: {
                type: Number,
                value: 0
            },
            treePath: {
                type: Object,
                value: ['root']
            },
            childLazyNodes: {
                type: Object,
                value: []
            },
            lazyNodeID: {
                type: String,
                value: 'root'
            }
        },

        factoryImpl: function(level, treePath) {
            this.level = level;
            this.treePath = treePath;
            this.nodeLabel = this.getNodeLabel(this.treePath);
            this.lazyNodeID = this.arrayToLabelString(this.treePath, '-');
        },

        listeners: {
            'click': 'handleClick'
        },

        handleClick: function (e) {
            e.stopPropagation();
            var childLevel = this.level + 1;
            var childPaths = this.loadChildren(this.treePath);
            for (var i = 0; i < childPaths.length; i++) {
                var childPath = childPaths[i];
                var child = new LazyNode(childLevel, childPath);
                this.childLazyNodes.push(child);
                var thisID = this.arrayToLabelString(this.treePath, '-');
                this.$$('#' + thisID).appendChild(child);
            }
        },

        arrayToLabelString: function(array, separator) {
            separator = separator || ', ';
            var labelStr = '';
            var len = array.length;
            array.forEach(function(e, i) {
                labelStr += e;
                if (i < len - 1) labelStr += separator;
            });
            return labelStr;
        },

        /*
         * Returns the label for the node at treePath.
         */
        getNodeLabel: function(treePath) {
            var term = this.arrayToLabelString(treePath);
            term += " (" + this.level + ")";
            return term;
        },

        MAX_CHILD_NODES: 10,
        MAX_NODES_L1: 100,
        /*
         * Returns an array of labels for all children under the node at treePath.
         * treePath starts with ['root'] for the root node. Then ['root', 0] is the first child of the root.
         * ['root', 1] is the second child of the root. etc.
         * Placeholder for an API endpoint call.
         */
        loadChildren: function(treePath) {
            var numNodes;
            var maxNodes;
            if (!treePath) return [];
            if (treePath.length === 1) {
                maxNodes = this.MAX_NODES_L1;
            } else {
                maxNodes = this.MAX_CHILD_NODES;
            }
            numNodes = Math.max(Math.floor(Math.random() * maxNodes), 1);
            var nodes = [];
            for (var i = 0; i < numNodes; i ++) {
                nodes.push(treePath.concat(i));
            }
            return nodes;
        },


        created: function() {
            //console.log(this.localName + '#' + this.id + ' was created');
        }

    });

</script>
